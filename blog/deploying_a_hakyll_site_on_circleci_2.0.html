<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inconsolata">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-grid.css">
    <link rel="stylesheet" type="text/css" href="../css/site.css">
    <link rel="stylesheet" type="text/css" href="../css/syntax.css">
    
    <title>Deploying a Hakyll site on CircleCI 2.0</title>
  </head>
  <body>
    <div class="container">
      <h1>- Deploying a Hakyll site on CircleCI 2.0</h1>
      <h2>
  Posted on July  4, 2018
  
    by Andrew Dawson
  
</h2>
<h3>
  
  Tags: <a href="../blog/tags/CircleCI.html">CircleCI</a>, <a href="../blog/tags/Haskell.html">Haskell</a>, <a href="../blog/tags/Hakyll.html">Hakyll</a>
  
</h3>

<p>This site is generated using the <a href="https://jaspervdj.be/hakyll/">Hakyll</a> library and deployed to Github Pages using CircleCI 2.0. This post provides some details on how this is done.</p>
<div>

</div>
<!--more-->
<h1 id="deployment-of-the-site">Deployment of the site</h1>
<p>The site is hosted on Github Pages as a user site in the repository <a href="https://github.com/ajdawson/ajdawson.github.io">ajdawson.github.io</a>. I like to keep the source in a separate repository <a href="https://github.com/ajdawson/website-hakyll">website-hakyll</a>. In order to make changes to the site I must make my edits in the source repository, generate the site from the edited source, then move the result over to the deployment repository and push the changes to Github. I want this to be automated so that all I have to do is commit and push changes to source repository, and have the site rebuilt and redeployed by itself.</p>
<p>To achieve this I am using <a href="https://circleci.com">CircleCI</a>. This post outlines the steps needed to make this work using version 2.0 of CircleCI.</p>
<h1 id="setting-up-circleci-and-github">Setting up CircleCI and Github</h1>
<p>I am hosting source code in a separate repository to the deployed site. Therefore my CircleCI build process requires read-only access to my <a href="https://github.com/ajdawson/website-hakyll">source github repository</a>, and read-write access to my <a href="https://github.com/ajdawson/ajdawson.github.io">deployment github repository</a>.</p>
<h2 id="generating-a-key-for-the-source-repository">Generating a key for the source repository</h2>
<p>This step can be done with a few clicks in the CircleCI interface, in the project settings go to <em>Checkout SSH keys</em> and click <em>Add Deploy Key</em>. This generates a read-only deploy key for the project and provides it to your build process.</p>
<h2 id="generating-a-key-for-the-destination-repository">Generating a key for the destination repository</h2>
<p>This step is a bit more manual because I need to add an SSH key for a different repository than the one the build is configured for. CircleCI provide instructions on how to do this, the steps I took are:</p>
<ol style="list-style-type: decimal">
<li><p>Create an SSH key pair (but do not use a passphrase):</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">ssh-keygen</span> -t rsa -b 4096 -C <span class="st">&quot;your.email@example.com&quot;</span></code></pre></div></li>
<li><p>Go to your deployment repository on Github and add a read-write deploy key containing the public part of the key you just generated.</p></li>
<li>Go to the SSH settings page of the <em>source</em> repository on CircleCI and add the private key specifying <code>github.com</code> as the host.</li>
<li><p>Add an <code>add_ssh_keys</code> step to your build (see <code>.circleci/config.yml</code> below) to make sure the key is available to use in your build.</p></li>
</ol>
<h1 id="configuring-the-circle-ci-build">Configuring the Circle CI build</h1>
<p>The configuration for CircleCI 2.0 is quite different from 1.0. I followed the guidance in <a href="https://futtetennismo.me/posts/hakyll/2017-10-22-deploying-to-github-pages-using-circleci-2.0.html">this post</a> to get the basics set up, with a few modifications. My <code>.circleci/config.yaml</code> looks like this:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">version:</span><span class="at"> 2</span>
<span class="fu">jobs:</span>
  <span class="fu">build:</span>
    <span class="fu">docker:</span>
      <span class="kw">-</span> <span class="fu">image:</span><span class="at"> futtetennista/hakyll:latest</span>
    <span class="fu">steps:</span>
      <span class="kw">-</span> <span class="fu">add_ssh_keys:</span>
          <span class="fu">fingerprints:</span>
            <span class="kw">-</span> <span class="st">&quot;c6:14:32:cc:50:2a:c5:43:45:3d:8c:cf:b3:09:80:a3&quot;</span>
      <span class="kw">-</span> checkout
      <span class="kw">-</span> <span class="fu">restore_cache:</span>
          <span class="fu">keys:</span>
            <span class="kw">-</span> v1-stack-work-<span class="kw">{</span>{ checksum &quot;site.cabal&quot; <span class="kw">}</span>}
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> Build the static site generator executable</span>
          <span class="fu">command:</span><span class="at"> stack build</span>
      <span class="kw">-</span> <span class="fu">save_cache:</span>
          <span class="fu">key:</span><span class="at"> v1-stack-work-{{ checksum &quot;site.cabal&quot; }}</span>
          <span class="fu">paths:</span>
            <span class="kw">-</span> ~/website-hakyll/.stack-work
            <span class="kw">-</span> /root/.stack
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> Build the site</span>
          <span class="fu">command:</span><span class="at"> stack exec site rebuild</span>
      <span class="kw">-</span> <span class="fu">store_artifacts:</span>
          <span class="fu">path:</span><span class="at"> _site</span>
          <span class="fu">destination:</span><span class="at"> built_site</span>
      <span class="kw">-</span> <span class="fu">deploy:</span>
          <span class="fu">name:</span><span class="at"> Deploy to Github Pages</span>
          <span class="fu">command:</span><span class="at"> |</span>
            if <span class="kw">[</span> <span class="st">&quot;${CIRCLE_BRANCH}&quot;</span> == <span class="st">&quot;master&quot;</span> <span class="kw">]</span>; then
              .circleci/deploy.sh
            fi</code></pre></div>
<p>This performs all the necessary steps to set up the build (including dependency caching), build the site, and optionally deploy it.</p>
<p>It also stores the built site as a build artifact, which can be accessed on the build artifacts tab in the CircleCI interface. Doing this allows me to submit a PR to my source repository, have it built (but not deployed) on CircleCI, and review the change to the site. I can then merge the PR into the master branch where CircleCI will build it again and deploy it automatically.</p>

      <ul class="nav">
        <li>[<a href="../index.html">home</a>]</li>
        <li>[<a href="../blog.html">blog</a>]</li>
        <li>[<a href="../software.html">software</a>]</li>
        <li>[<a href="../pubs.html">publications</a>]</li>
        <li>[<a href="../contact.html">contact</a>]</li>
      </ul>
    </div>
  </body>
</html>
